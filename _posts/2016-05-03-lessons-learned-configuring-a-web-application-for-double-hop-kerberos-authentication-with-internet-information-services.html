---
layout: post
title: "Lessons learned configuring a web application for double hop Kerberos authentication with Internet Information Services"
date: 2016-05-03 12:00 UTC
---

<div id="post">

<p>This post summarizes lessons learned setting up a web application
for use of Kerberos authentication with delegation. First we assert
that prerequisites for Kerberos and Internet Information Services
(IIS) are met. Then we setup an IIS test web application with build-in
Kerberos support to delegate the user's credentials. Lastly, we verify
the setup by having the test application call into a Kerberos-enabled
SharePoint installation on behalf of the user browsing it.</p>

<p>In terms of system overview, here's what the setup looks like:</p>

<pre>
Client browser <-> Test web app <-> SharePoint 2013 on-premise server
</pre

<p>Being able to call SharePoint APIs using different identities
allows for making select calls using either a privileged account or
the calling user's account. The former implies that a user with
otherwise limited permissions may request the creation of site
collections or webs and the latter that the web application can make
calls on behalf of the user and still take advantage of SharePoint's
build-in security, such as security trimming search results (otherwise
the application would have to do its own trimming).</p>

<h2>Asserting prerequisites</h2>

<p>Before getting to the IIS part, let's first ensure that Active
Directory and
<a href="http://www.roguelynn.com/words/explain-like-im-5-kerberos">Kerberos</a>
(with delegation) have been configured to match our needs.</p>

<h4>Service Principal Names</h4>

<p>On Windows, Kerberos is an integral part of an Active Directory
domain controller. Hence it must have a binding added to tie the
account under which the application pool of our test web app runs to
the endpoint where the web application is to run. Kerberos calls this
one-to-many relationship between account and endpoint a Service
Principal Name (SPN).</p>

<p>For the client and server to verify each other's identify, a
matching SPN must exist. This prevents just any application pool
account (any web application) from accepting calls on any host, let
alone call another system, acting on behalf of the user. At a high
level, the authentication works by having the client ask the Kerberos
server for a ticket (a piece of data) which the Kerberos server
encrypts before passing it to the client. The client passes the ticket
on to the web application, which is the only one who can decrypt it by
means of public key cryptography. The public/private keys required for
this to work is what gets setup when registering an SPN.</p>

<p>The presence of an SPN can be verified with the
<a href="https://technet.microsoft.com/en-us/library/cc731241.aspx">setspn</a>
command. Despite its name it's used for both setting and querying
principals. An Active Directory domain administrator must have made a
prior call to setspn to create the principal.</p>

<pre>
%&gt; setspn &lt;domain&gt;\&lt;app-pool-account&gt;
Registered ServicePrincipalNames for CN=&lt;app-pool-account&gt;,OU=AD,OU=ServiceAccounts,OU=AcmeCorp,DC=&lt;domain&gt;,DC=local:
    HTTP/&lt;my-server-1&gt;.&lt;domain&gt;.local
    HTTP/&lt;my-server-1&gt;
    HTTP/&lt;my-server-2&gt;.&lt;domain&gt;.local
    HTTP/&lt;my-server-2&gt;
</pre>

<p>From the output we see that four principals have been registered
with the app pool account. It's common for a server to have two
registered principals matching DNS host name and NetBIOS name,
respectively. From the list, we've asserted that our test application
may be installed on either server, running under the given app pool
account.</p>

<h4>Delegation</h4>

<p>Now, let's verify the app pool account's ability to not only
receive calls, but delegate the received credentials, i.e., call
another system, passing along the calling user's credentials and
acting on behalf of the calling user. This makes the client and other
system two hops apart and it's this double hop ability of Kerberos
that distinguishes it from NTLM. The notion of double hop applies by
induction between any two hosts, possibly extending the distance
between the original client and final host to more than two hops. Any
app pool account and server along the path must then be setup with
SPNs and delegation.</p>

<p>An account isn't allowed to delegate by default. To verify this
setting for the app pool account, locate it within Windows Active
Directory Users and Groups. Under the user's Properties, on the
Delegation tab, ensure that "Trust this user for delegation to any
service (Kerberos only)" is selected. The more limited option of
constrained delegation may be selected instead. Then any service we
wish to connect to must be explicitly whitelisted.</p>

<h4>Domain names</h4>

<p>The syntactic resemblance between SPNs and DNS host names is no
coincidence. Assuming the machine name is different from the desired
host name of our service (which would be good practice), a matching
DNS entry must exist for Kerberos to operate. More specifically, the
URL part of the SPN must match a DNS A record. The Kerberos client
library makes use of DNS lookup as part of requesting a ticket to the
service.</p>

<p>We can verify that DNS has been correctly setup using
the <a href="https://technet.microsoft.com/en-us/library/cc725991.aspx">nslookup</a>
command.

<pre>
%&gt; nslookup -type=a &lt;my-server-1&gt;.&lt;domain&gt;.local

Server:   &lt;dns-host&gt;.&lt;domain&gt;.net
Address:  &lt;some-ip&gt;

Non-authoritative answer:
Name:     &lt;my-server-1&gt;.&lt;domain&gt;.local
Address:  &lt;some-other-ip&gt;
</pre>

<p>nslookup returned a single result, and assuming the IP points to
our server, our prerequisites have been met and we can continue with
the setting up IIS and our web app. Beforehand, a few limitations of
Windows and Chrome may be worth considering.</p>

<h4>Limitations of Windows Kerberos and Chrome</h4>

<p>At this point, a few Windows specific Kerberos caveats are worth
mentioning. One
<a href="http://www.sbrickey.com/Tech/Blog/Post/IE_and_Net_Framework_Feature_Request_Fix_support_for_Kerberos_for_non-default_ports">limitation</a>
is that only a single principal per hostname is supported. The
Kerberos client library doesn't include a port number when asking
Kerberos to provide it a ticked to pass along to the service. Hence we
cannot have applications running on different ports using different
app pool accounts and have those work with Kerberos.</p>

<p>Another <a href="https://technet.microsoft.com/en-us/library/gg502606.aspx">limitation</a>
is that only DNS A records, and not DNS CNAME aliases, are
supported. Again, this is due to the client Kerberos library not
querying for a matching CNAME when requesting a ticket from
Kerberos. With only a CNAME the client library fails to resolve the
host and with both a CNAME and A record (possibly pointing to
different IPs), the A record is used. In case the resolution doesn't
match the principal name, authentication fails.</p>

<p>While on the outset these issues may seem minor, they are likely
not obvious when tracking down issues with Kerberos. In large
organizations where principal and DNS changes may take time to
propagate, they can slow down deployment. Thus, it's best to be on the
watch for these limitations.</p>

<p>Lastly, Google Chrome defaults to not delegate user credentials
with Kerberos. In principle this is easily fixed
by <a href="http://dev.chromium.org/administrators/policy-list-3#AuthNegotiateDelegateWhitelis">whitelisting</a>
the web app URL. But again, rolling out an organization-wide registry
change with group policies may take time. Not making the change,
Chrome yields a HTTP 401 error when the user visits an endpoint
attempting delegation.</p>

<h3>Internet Information Services</h3>

<p>Setting up a web application under a web site in IIS Manager, the
new application inherits settings from its parent. Thus, depending on
your IIS setup, some settings below may already have the designated
values:</p>

<ol>

<li>Create a new application and either select an existing app pool
running under the identity of the aforementioned principal or create a
new app pool and adjust its identity later.</li>

<li>For the new application, under Authentication, make sure Windows
Authentication is enabled.</li>

<li>Selecting Windows Authentication, Advanced Settings..., make sure
that <a href="https://support.microsoft.com/en-us/kb/973917">Extended
Protection</a> is Off and that
Enable <a href="https://blogs.msdn.microsoft.com/amol/2010/10/29/understanding-kernel-mode-authentication-in-iis-7">Kernel
Mode authentication</a> is disabled. As
<a href="https://technet.microsoft.com/en-us/library/gg502606.aspx">outlined</a>,
Kernel mode improves authentication performance by having the kernel,
not the user-mode IIS process, authenticate the Kerberos ticket. While
saving a few context switches is important on high-load web sites,
kernel mode isn't supported with load balanced web servers. Kernel
mode processes tickets using a special computer identity instead of
the app pool identity. With load balancing, this makes the machine
that initially received the request different from the one processing
it. On Windows, where Kerberos employs public key cryptography to
validate the tickets, the secret key by kernel mode cannot perform the
validation.</li>

<li>Under Providers, make sure the order is Negotiate/NTLM. It
<a href="https://msdn.microsoft.com/en-us/library/ms789031(v=vs.110).aspx">means</a>
authentication assumes Kerberos first and if it fails falls back to
NTLM. Strictly speaking, NTLM is in the Providers list twice. NTLM
would still be a usable in single hop scenario.</li>

</ol>

<p>Installing
the <a href="http://www.iis.net/downloads/community/2009/06/delegconfig-v2-beta-delegation-kerberos-configuration-tool">DelegConfig</a>
into our newly create web app allows us to do end-to-end verification
of Kerberos with delegation. DelegConfig issues HTTP GET requests
passing along the user's credential to a URL of our choosing and
displays the resulting HTML inside the app. With DelegConfig and its
Test.aspx page, we can issue a GET request to a SharePoint REST
service asking for the user name of the current user (via
https://server/path-to-web/_api/Web/CurrentUser). Now user information
for the user accessing DelegConfig accessing SharePoint should be
visible inside DelegConfig.</p>

<h4>Conclusion</h4>

<p>With the shift to cloud and SharePoint
Online, <a href="https://en.wikipedia.org/wiki/OAuth">OAuth</a> and
Azure Active Directory dominate the authentication
landscape. On-premise, however, Kerberos is still very much
alive. While their authentication flows are similar, Kerberos can be
particular tricky to setup and troubleshoot as it's an old binary
protocol dating back to the early eighties and typically relying on
operating system infrastructure such as Active Directory.</p>

</div>

