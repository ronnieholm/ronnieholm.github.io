---
layout: post
title: "Mapping application components to Azure Active Directory applications"
date: 2018-10-21 12:00 UTC
---

<div id="post">

<p>Developing applications which must authorize against <a
href="https://docs.microsoft.com/en-us/azure/active-directory">Azure
Active Directory</a>, one point of confusion seems to be the number of
app registrations required. From blog posts and the Azure portal's App
registration page, one might be misled into creating fewer app
registrations, which may technically work, but which doesn't map well
to the architecture and how it's likely to evolve.</p>

<p>As a working example, consider the use case of a native iOS
application which must make authenticated calls to an ASP.NET Core Web
API REST service. Add to the mix an Angular app also required to make
authorized calls the Web API.</p>

<p>With these three components, the iOS app, the REST service, and the
Android app, inside the Azure portal, creating a new App registration,
we have a choice between "Web app / API" or "Native" for the
application type. The mapping of iOS app to "Native" and the Web API
service to "Web app / API" is straightforward, but what about the
Angular app?</p>

<p>Most likely in the name of brevity, blog posts tends to re-use the
app registration for the Web API for the Angular client. Reusing an
app registration is at best a shortcut to avoid a third app
registration and at worst a potential security risk. In all but the
simplest architectures, the Angular app should have its own app
registrations.</p>

<p>The main reasons include:</p>

<ul>

<li><p>Logically the frontend and backend are distinct parts of a
system, created with distinct technologies and with distinct
authorization needs. The two are deployed independently, to different
Azure app services, and may reside in different source code
repository. Reusing the app registration may be a mental leftover from
when frontend and backend are intermingled in a postback-driven
ASP.NET app with occasional JavaScript calls.</p></li>

<li><p>An Angular app may be targeting multiple services: our
services, Graph, Delve, SharePoint, Exchange, Azure endpoints. It's
not tied to any particular service, except for the convenience of not
creating a separate app registration for it. App registrations are
free in terms of monetary cost and close to free in terms of cognitive
overhead. Frugality doesn't apply to app registrations.</p></li>

<li><p>App registration metadata differ between an Angular app and a
REST service. Maybe not in a significant way at first, but it's only a
matter of time. Then we'd either have to split the registration into
two, maybe forcing users to re-consent, or have the registration
contain the union of the settings of the two.</p></li>

<li><p>By design, the Angular app requires
the <a href="https://docs.microsoft.com/en-us/azure/active-directory/develop/v1-oauth2-implicit-grant-flow">implicit
grant type</a> flow whereas the Web API doesn't. App registrations
have implicit grant flow disabled by default. The Angular app makes
use of reply URLs whereas the Web API doesn't, and the Angular app
likely accesses a different set of Web APIs than a specific
service. Thus, a number of settings for an Angular app are specific to
it, meaning it should be recorded in its own app
registration.</p></li>

</ul>

<p>To support our use case, from Angular we use the
<a href="https://github.com/AzureAD/azure-activedirectory-library-for-js">ADAL.js</a>
library (via
a <a href="https://github.com/benbaran/adal-angular4">wrapper</a>
and <a href="https://github.com/benbaran/adal-angular6-example">example</a>),
and hence are limited to the v1.0 Azure Active Directory authorization
endpoint. Despite security concerns of the implicit grant type flow
relative to others, ADAL.js uses the implicit grant flow.</p>

To quote
Microsoft's <a href="https://docs.microsoft.com/en-us/azure/active-directory/develop/azure-ad-endpoint-comparison">comparison
of v1.0 and v2.0 endpoints</a>:

<quote>
You can use the v2.0 endpoint
[with <a href="https://github.com/AzureAD/microsoft-authentication-library-for-js">MSAL.js</a>,
not ADAL.js]
to <a href="https://docs.microsoft.com/en-us/azure/active-directory/develop/v2-app-types#web-apis">build
a Web API that is secured with OAuth 2.0</a>. However, that Web API
can receive tokens only from an application that has the same
Application ID. <b>You cannot access a Web API from a client that has
a different Application ID</b>. The client won't be able to request or
obtain permissions to your Web API.
</quote>

<p>This limitation in inherent in Microsoft OAuth2 implementation, not
the standard itself. We have the iOS application with it own app
registration, and hence application id, not to mention the Angular
application.</p>

<p>With the use case we set out with, for the reasons above we should
end up with three app registration. This ensure the optimal mapping
between architectural components and app registrations, now and in the
future. The iOS application uses
the <a href="https://docs.microsoft.com/en-us/azure/active-directory/develop/v1-protocols-oauth-code">authorization
grant type</a> flow and the Angular application uses
the <a href="https://docs.microsoft.com/en-us/azure/active-directory/develop/v1-oauth2-implicit-grant-flow">implicit
grant type</a> flow.</p>
  
</div>
