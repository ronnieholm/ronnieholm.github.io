---
layout: post
title: "Mapping application components to Azure Active Directory applications"
date: 2018-10-21 12:00 UTC
---

<div id="post">

<p>Developing a real-world application with multiple components which
must all authorize
against <a href="https://docs.microsoft.com/en-us/azure/active-directory">Azure
Active Directory</a>, a common point of confusion is the number of app
registrations needed. Blog posts tend to focus on simple scenarios and
the guidance provided on the Azure Portal's App registration page
isn't exhaustive. It's easy to err on the side of registering too few
apps, which may technically work in the beginning, but doesn't map
well to the components and how they're likely to evolve.</p>

<p>This post attempts to provide common points of reasoning to aid in
determining when to create an app registration.</p>

<h3>Real-world use case</h3>

<p>As a example, consider the following application implemented as a
distributed set of components: a native iOS application which must
make authenticated calls to an ASP.NET Core Web API. Add to the mix an
Angular app also required to make authorized calls the Web API.</p>

<p>Inside the Azure portal, creating a new App registration, we have a
choice between "Web app / API" or "Native" for the application
type. Within the <a href="https://tools.ietf.org/html/rfc6749">OAuth2
specification</a>, application types are
called <a href="https://tools.ietf.org/html/rfc6749#section-2.1">client
profiles</a>, and there's three options: web application,
user-agent-based application (a fancy term for a browser), and native
application. The Azure Portal merges the user-agent-based application
with "Web app / API", and it's implicitly selected by flipping the
manifest's <a href="https://docs.microsoft.com/en-us/azure/active-directory/develop/reference-app-manifest">oauth2AllowImplicitFlow</a>
setting to true.
</p>

<p>With these definitions, it's clear that iOS app maps to "Native"
and Web API to "Web app / API", but what about the Angular app? Well,
it's a also a "Web app / API" but can we fold it under the Web API
registration?</p>

<h3>Points of reasoning</h3>

<p>Perhaps in the name of brevity blog posts often re-use the app
registration for the Web API for the Angular client. But reusing an
app registration is at best a shortcut to avoid an additional app
registration and at worst a potential security risk. In all but the
simplest use cases, the Angular app should have its own app
registration:</p>

<ul>

<li><p>Logically frontend and backend are distinct components of the
application, created with distinct technologies and with distinct
authorization needs. The two are likely deployed to different Azure
app service instance, and may reside in different source code
repositories. Making the two share an app registration may be
reminiscent of when frontend and backend were intermingled in a
postback-driven app with occasional JavaScript calls.</p></li>

<li><p>An Angular app may be targeting multiple endpoints: our Web
APIs, Graph, Delve, SharePoint, Exchange. It's not tied to one
service, except perhaps for the convenience of not having to create an
additional app registration. But with the zero monetary cost, there's
no need to be frugal about app registration, though they might
contribute a slight cognitive overhead.</p></li>

<li><p>App registration metadata differ between an Angular app and a
Web API. Maybe not in a significant way at first, but in time they
drift apart. Then we must either split the registration, maybe forcing
users to re-consent, or make the single registration contain a union
of settings, if at all possible.</p></li>

<li><p>By design, an Angular app requires
the <a href="https://docs.microsoft.com/en-us/azure/active-directory/develop/v1-oauth2-implicit-grant-flow">implicit
grant type</a> of flow whereas the Web API doesn't. App registrations
have implicit grant type of flow disabled by default. An Angular app
also requires reply URLs whereas the Web API doesn't, and over time an
Angular app will likely access a different set of APIs than any
specific service. Thus, settings for an Angular app are specific to
it, meaning it should have its own app registration.</p></li>

</ul>

<h3>ADAL.js vs MSAL.js</h3>

<p>To support the use case, from Angular we must use the
<a href="https://github.com/AzureAD/azure-activedirectory-library-for-js">ADAL.js</a>
library (indirectly through
a <a href="https://github.com/benbaran/adal-angular4">wrapper</a> and
this <a href="https://github.com/benbaran/adal-angular6-example">sample</a>). Despite
security concerns compared to
the <a href="https://docs.microsoft.com/en-us/azure/active-directory/develop/v1-protocols-oauth-code">authorization
code type</a> of flow, ADAL.js implements the implicit grant type of
flow, and in the process limits us to the v1.0 Azure Active Directory
authorization endpoint.</p>

<p>To quote
Microsoft's <a href="https://docs.microsoft.com/en-us/azure/active-directory/develop/azure-ad-endpoint-comparison">comparison
of v1.0 and v2.0 endpoint capabilities</a>:</p>

<blockquote>
You can use the v2.0 endpoint
[with <a href="https://github.com/AzureAD/microsoft-authentication-library-for-js">MSAL.js</a>,
not ADAL.js]
to <a href="https://docs.microsoft.com/en-us/azure/active-directory/develop/v2-app-types#web-apis">build
a Web API that is secured with OAuth 2.0</a>. However, that Web API
can receive tokens only from an application that has the same
Application ID. <b>You cannot access a Web API from a client that has
a different Application ID</b>. The client won't be able to request or
obtain permissions to your Web API.
</blockquote>

<p>It's a limitation inherent in Microsoft's OAuth2 implementation
rather than the OAuth2 standard itself. In our case, we have the iOS
application, not to mention the Angular app, with separate app
registrations, and hence application ids, which differ from that of
the Web API.</p>

<h3>Summary</h3>

<p>Starting from the initial use case, we end up with three app
registrations to support an optimal mapping between components and app
registrations, now and in the future. The iOS and Angular app uses the
authorization grant type and implicit grant type of flow,
respectively.</p>
  
</div>
