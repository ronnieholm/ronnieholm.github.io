---
layout: post
title: "Informally speed testing Azure blob storage"
date: 2015-03-13 12:00 UTC
tags: [C#]
---
<div id="post">

<p>As part of migrating a solution from on-premise to Azure cloud, we
have to decide between (1) physically sending a disk containing a few
terabytes of database backups to Microsoft, and have Microsoft upload
its content to Azure blob storage, or (2) upload the contents
ourselves. Once in Azure blob storage, the database backups are to be
extracted and restored on multiple MS SQL servers to complete the
migration in parallel.</p>

<h2>Setup</h2>

<p>As a crude measure of the upload capacity of Azure blob storage, in
the Azure portal we setup a new "azurespeedtestpost" storage account
in North Europe and with locally redundant replication. Inside the
account, we created a "default" container with public access, meaning
everyone can upload blobs to it. Finally, in the portal, we fetched
the primary access key to include in the connection string.</p>

<p>Now, using the code below we're able to upload blobs of
configurable sizes:</p>

<pre class="prettyprint lang-cs">
// reference WindowsAzure.Storage NuGet package
using System;
using Microsoft.WindowsAzure.Storage;
using System.Diagnostics;

namespace AzureBlobStorageSpeedTest {
    class Program {
        const int Megabyte = 1024 * 1024;
        const int Megabit = 1000 * 1000;

        static double Time(Action codeToTime) {
            var w = new Stopwatch();
            w.Start();
            codeToTime();
            w.Stop();
            return w.ElapsedMilliseconds / 1000.0;            
        }

        static void Main(string[] args) {
            var sizeInMegabytes = int.Parse(args[0]);
            var contentLength = sizeInMegabytes * Megabyte;
            var randomizedContent = new byte[contentLength];
            new Random().NextBytes(randomizedContent);

            var account = CloudStorageAccount.Parse(
                "DefaultEndpointsProtocol=https;" +
                "AccountName=azurespeedtestpost;" +
                "AccountKey=OzgbBQ+nkuT0CRjbhyZ0dK3aIvpkDltEdQ3xvuCBsJlZThRFVEIJ6zXz050BENnw/c6aaVeOrCKz/oNM5UYAeQ==");
            var client = account.CreateCloudBlobClient();
            client.DefaultRequestOptions.ParallelOperationThreadCount = 24;
            var container = client.GetContainerReference("default");
            var blob = container.GetBlockBlobReference("test-" + DateTime.Now);

            var uploadTime = Time(() => blob.UploadFromByteArray(randomizedContent, 0, contentLength));
            var downloadTime = Time(() => blob.DownloadRangeToByteArray(randomizedContent, 0, 0, contentLength));

            Console.WriteLine(
                "{0} megabytes uploaded in {1:0.0} seconds at {2:0.0} megabits/second\r\n" +
                "{0} megabytes downloaded in {3:0.0} seconds at {4:0.0} megabits/second",
                sizeInMegabytes, uploadTime, contentLength / uploadTime * 8 / Megabit,
                downloadTime, contentLength / downloadTime * 8 / Megabit);
        }
    }
}
</pre>

<p>Note how the application allocates a byte array of the designated
size in megabytes. With the 2GB memory allocation limit of 32 bit
Windows processes, to avoid out of memory exceptions, make sure to
compile the application in 64 bit mode.</p>

<h2>Execution</h2>

<p>Running the speed test application on an Azure virtual machine
running Windows 2012 and likely a server-optimized network stack and
likely with close to direct connection to Azure blob storage, here's a
representative result:</p>

<pre>
%> ./AzureBlobStorageSpeedTest 1024
1024 megabytes uploaded in 51.1 seconds at 168.2 megabits/second
1024 megabytes downloaded in 140.8 seconds at 61.0 megabits/second
</pre>

<p>On my Windows 7 laptop, running outside the Azure network, with a
gigabit network card and an internet connection capable of well over
200 megabits/second according
to <a href="http://speedtest.net">speedtest.net</a>, a representative
result is as follows:</p>

<pre>
%> ./AzureBlobStorageSpeedTest 1024
1024 megabytes uploaded in 71.932 seconds at 119 megabits/second
1024 megabytes downloaded in 188.972 seconds at 45 megabits/second
</pre>

<h2>Conclusion</h2>

<p>For a content size of a couple of terabytes, uploading ourselves is
sufficiently fast to not warrant shipping a disk to Microsoft. Even
setting the bar at 50 megabits/second, uploading a terabyte takes
about two days (1024^4 / 5E+07 / 60^2 / 24). But that doesn't factor
in the possibility of uploading blobs in parallel from multiple
locations -- separate networks or multiple computers on the same
network -- and re-assembling these once in storage.</p>

</div>
