---
layout: post
title: "Informally speed testing Azure blob storage"
date: 2015-03-13 12:00 UTC
tags: [C#]
---
<div id="post">

<p>As part of migrating a solution from on-premise to Azure cloud, we
have to decide between (1) physically sending a disk containing a few
terabytes of database backups to Microsoft, and have Microsoft upload
its content to Azure blob storage, or (2) upload the contents
ourselves. Once in Azure blob storage, the database backups are to be
extracted and restored on multiple MS SQL servers to finish migrating
in parallel.</p>

<h2>Setup</h2>

<p>As a crude measure of the upload capacity of Azure blob storage, in
the Azure portal we setup a new "azurespeedtestpost" storage account
in North Europe and with locally redundant replication. Inside the
account, we created a "default" container with public, meaning
everyone can upload to it. Finally, in the portal, we fetched the
primary access key to include in the connection string.</p>

<p>Now, using the code below we're able to upload blobs of
configurable sizes:</p>

<pre class="prettyprint lang-cs">
// reference WindowsAzure.Storage NuGet package
using System;
using Microsoft.WindowsAzure.Storage;
using System.Diagnostics;

namespace AzureBlobStorageSpeedTest {
    class Program {
        const int Megabyte = 1024 * 1024;
        const int Megabit = 1000 * 1000;

        static void Main() {
            Console.Write("Enter blob size in megabytes: ");
            var sizeInMegabytes = Console.ReadLine();
            var randomizedContent = new byte[Int32.Parse(sizeInMegabytes) * Megabyte];
            new Random().NextBytes(randomizedContent);

            var account = CloudStorageAccount.Parse(
                "DefaultEndpointsProtocol=https;" +
                "AccountName=azurespeedtestpost;" +
                "AccountKey=OzgbBQ+nkuT0CRjbhyZ0dK3aIvpkDltEdQ3xvuCBsJlZThRFVEIJ6zXz050BENnw/c6aaVeOrCKz/oNM5UYAeQ==");
            var client = account.CreateCloudBlobClient();

            // adjust for optimal performance
            client.DefaultRequestOptions.ParallelOperationThreadCount = 24;
            var container = client.GetContainerReference("default");
            var blob = container.GetBlockBlobReference("test-" + DateTime.Now);

            var watch = new Stopwatch();
            watch.Start();
            blob.UploadFromByteArray(randomizedContent, 0, randomizedContent.Length);
            watch.Stop();           

            Console.WriteLine(
                "{0} megabytes uploaded in {1} seconds at {2} megabits/second",
                sizeInMegabytes, watch.ElapsedMilliseconds / 1000.0,
                (int)(randomizedContent.Length / (watch.ElapsedMilliseconds / 1000.0) * 8 / Megabit));
        }
    }
}

</pre>

<p>Note how the application allocates a byte array of the designated
size in megabytes. With the 2GB memory allocation limit of 32 bit
Windows processes, to avoid out of memory exceptions, make sure to
compile in 64 bit mode.</p>

<h2>Conclusion</h2>

<p>Running the speed test application on an Azure virtual machine
running Windows 2012 and likely a server-optimized network stack and
likely with close to direct connection to Azure blob storage, here's a
representative result:</p>

<pre>
Enter blob size in megabytes: 1024
1024 megabytes uploaded in 54.629 seconds at 157 megabits/second
</pre>

<p>On my Windows 7 laptop, running outside the Azure network, with a
gigabit network card and an internet connection capable of roughly 200
megabits/second according
to <a href="http://speedtest.net">speedtest.net</a>, a representative
result is as follows:</p>

<pre>
Enter blob size in megabytes: 1024
1024 megabytes uploaded in 71.932 seconds at 119 megabits/second
</pre>

<p>In conclusion, for a content size of a couple of terabytes,
uploading ourselves is sufficiently fast to not warrant shipping a
disk to Microsoft. Even setting the bar at 50 megabits/second,
uploading a terabyte takes about two days (1024^4 / 5E+07 / 60^2 /
24). But that doesn't factor in uploading blobs in parallel from
multiple locations and re-assembling these once in blob storage.</p>

</div>
