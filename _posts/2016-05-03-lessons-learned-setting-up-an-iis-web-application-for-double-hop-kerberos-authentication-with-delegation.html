---
layout: post
title: "Lessons learned setting up an IIS web application for double-hop Kerberos authentication with delegation"
date: 2016-05-03 12:00 UTC
---

<div id="post">

<p>This post summarizes the lessons learned setting up an IIS web
application using Kerberos authentication with delegation. After
asserting that prerequisites for Kerberos and Internet Information
Services (IIS) are met, we setup a web application delegating the
user's credentials. We verify the setup by having the web application
call into a Kerberos-enabled SharePoint installation on behalf of the
user browsing it.</p>

<p>In terms of system overview, here's what the setup looks like:</p>

<pre>
Client browser <-> Test web app <-> SharePoint 2013 on-premise server
</pre

<p>Calling SharePoint APIs through an intermediate service, and having
the service vary between using privileged credentials and the calling
user's credentials, allows for on-demand elevation of privileges. A
user with limited permissions may then request the creation of site
collections or webs while otherwise taking advantage of SharePoint's
build-in security model. For instance, search results are still
Security trimmed by SharePoint.</p>

<h2>Asserting prerequisites</h2>

<p>Before getting to the IIS part, let's first ensure that Active
Directory and
<a href="http://www.roguelynn.com/words/explain-like-im-5-kerberos">Kerberos</a>
with delegation have been setup to match our needs.</p>

<h4>Service Principal Names</h4>

<p>On Windows, Kerberos is an integral part of the Active Directory
domain controller. Active Directory therefore must have a binding
registered which relates the account under which the app pool of the
web app runs to the endpoint of the web application. Kerberos calls
this one-to-many relationship a Service Principal Name (SPN).</p>

<p>The SPN is what enables client and server to validate each other's
identify, and is what prevents a random app pool account (any web
application) from accepting calls on any endpoint, let alone call
another system on the user's behalf. Validation works by having the
client ask Kerberos (Active Directory) for a ticket (a piece of data),
which is encrypted by the Kerberos server before passed to the
client. The client passes on this ticket to the service, which is the
only service able to decrypt it. The binding between account and
endpoint is what enables the correct selection of public/private keys
required for this ticket processing to work.</p>

<p>The presence of an SPN can be verified with the
<a href="https://technet.microsoft.com/en-us/library/cc731241.aspx">setspn</a>
command. Despite its name it's used for both setting and querying
principals. An Active Directory domain administrator must have made a
prior call to setspn to create the principal.</p>

<pre>
%&gt; setspn &lt;domain&gt;\&lt;app-pool-account&gt;
Registered ServicePrincipalNames for CN=&lt;app-pool-account&gt;,OU=AD,OU=ServiceAccounts,OU=AcmeCorp,DC=&lt;domain&gt;,DC=local:
    HTTP/&lt;my-server-1&gt;.&lt;domain&gt;.local
    HTTP/&lt;my-server-1&gt;
    HTTP/&lt;my-server-2&gt;.&lt;domain&gt;.local
    HTTP/&lt;my-server-2&gt;
</pre>

<p>We see that four principals have been registered with the app pool
account. It's common for a server to have two registered principals
matching DNS host name and NetBIOS name, respectively. From the
output, we see that our web application may be installed on either
server and be able to receive Kerberos tickets.</p>

<h4>Delegation</h4>

<p>Now, let's verify the app pool account's ability to not only
receive Kerberos tickets, but also delegate those, i.e., call another
system, passing along the ticket/the calling user's credentials and
act on behalf of the calling user.</p>

<p>This'll separate the client from the final system by a double-hop
which applies by induction, extending the distance between the
original client to the final host by more than two hops. Support for
passing credentials along two or more hops is what distinguishes
Kerberos from NTLM. The only requirement is that any app pool account
and endpoint along the path must be setup with SPNs and delegation
(except the last one).</p>

<p>By default, an account isn't allowed to delegate. To verify this is
enabled for the app pool account, locate the account within Windows
Active Directory Users and Groups. Under the user's Properties, on the
Delegation tab, ensure that "Trust this user for delegation to any
service (Kerberos only)" is selected. The more limited option of
constrained delegation may be selected instead. Then any service we
wish to connect to must be explicitly whitelisted.</p>

<h4>Domain names</h4>

<p>The syntactic resemblance between SPNs and DNS host names is no
coincidence. Assuming the machine name is different from the host name
of our service (which would be good practice), a matching DNS entry
must exist for Kerberos to function. Specifically, the URL part of the
SPN must match a DNS A record which the Kerberos client library looks
up as part of requesting a ticket to the service.</p>

<p>We can verify that DNS has been correctly setup using
the <a href="https://technet.microsoft.com/en-us/library/cc725991.aspx">nslookup</a>
command.

<pre>
%&gt; nslookup -type=a &lt;my-server-1&gt;.&lt;domain&gt;.local

Server:   &lt;dns-host&gt;.&lt;domain&gt;.net
Address:  &lt;some-ip&gt;

Non-authoritative answer:
Name:     &lt;my-server-1&gt;.&lt;domain&gt;.local
Address:  &lt;some-other-ip&gt;
</pre>

<p>Here nslookup returned a single result, and assuming the IP does
indeed point to our server, our prerequisites have been met. Before
continuing with IIS and web app setup, a few limitations of Windows
and Chrome should be considered.</p>

<h4>Limitations with the Windows Kerberos client library and Chrome</h4>

<p>One
<a href="http://www.sbrickey.com/Tech/Blog/Post/IE_and_Net_Framework_Feature_Request_Fix_support_for_Kerberos_for_non-default_ports">limitation</a>
of the Kerberos client library is that because it doesn't include a
port number when asking Kerberos to provide is with a ticket, only a
single principal per hostname is supported. We cannot have
applications running on different ports using different app pool
accounts and have these work with Kerberos.</p>

<p>Another
client <a href="https://technet.microsoft.com/en-us/library/gg502606.aspx">limitation</a>
is that only DNS A records, and not DNS CNAME aliases, are used when
looking up the endpoint. With only a CNAME defined, the client library
fails to resolve the host and with both a CNAME and A record (possibly
pointing to different IPs), the A record is used. Again, the client
library cannot retrieve the ticket from Kerberos and authentication
fails.</p>

<p>While these issues may minor, they aren't obvious when tracking
down Kerberos issues. Also, waiting for a change to propagate trough
Active Directory and DNS may take considerable time in a large
organizations.</p>

<p>The final caveat we encountered was Google Chrome defaulting to not
delegate user credentials with Kerberos. In principle this is easily
fixed
by <a href="http://dev.chromium.org/administrators/policy-list-3#AuthNegotiateDelegateWhitelis">whitelisting</a>
the web app URL. But again, rolling out an organization-wide registry
change (with group policies) may take time. Not making the change,
Chrome yields a HTTP 401 error when the user visits an endpoint
attempting to delegate.</p>

<h3>Internet Information Services</h3>

<p>Setting up a web app under a web site in IIS Manager, the new
application inherits settings from its parent. Thus, depending on your
IIS setup, beware that some settings below may already have the
designated values:</p>

<ol>

<li>Create a new application and either select an existing app pool
running under the identity of the aforementioned service account or
create a new app pool and adjust its identity later.</li>

<li>For the new application, under Authentication, make sure Windows
Authentication is enabled.</li>

<li>Selecting Windows Authentication, Advanced Settings..., and make
sure
that <a href="https://support.microsoft.com/en-us/kb/973917">Extended
Protection</a> is Off and that
Enable <a href="https://blogs.msdn.microsoft.com/amol/2010/10/29/understanding-kernel-mode-authentication-in-iis-7">Kernel
Mode authentication</a> is disabled. Extended Protection offers extra
protection against man in the middle attacks (then why disable it?)
and
<a href="https://technet.microsoft.com/en-us/library/gg502606.aspx">Kernel
mode</a> improves authentication performance by having the kernel, not
the user-mode IIS process, authenticate the Kerberos ticket. While
saving context switches is important on high-load systems, kernel mode
isn't supported with load balanced web servers. It processes tickets
using a special computer identity and not the app pool identity. With
load balancing, this makes the machine which received the initial
request different from the one processing it, causing the
encryption/decryption keys used for the ticket to mismatch.</li>

<li>Under Providers, make sure the order is Negotiate/NTLM. It
<a href="https://msdn.microsoft.com/en-us/library/ms789031(v=vs.110).aspx">means</a>
authentication assumes Kerberos first and if that fails then fall back
to NTLM. Strictly speaking, NTLM is now in the Providers list twice,
but that's doesn't matter. NTLM by the way, is still perfectly usable
in single-hop scenario.</li>

</ol>

<p>Installing <a href="http://www.iis.net/downloads/community/2009/06/delegconfig-v2-beta-delegation-kerberos-configuration-tool">DelegConfig</a>
into our newly create web app allows for end-to-end validation of
Kerberos with delegation. DelegConfig issues HTTP GET requests,
passing along the user's credential to a URL of our choosing and
displays the resulting HTML inside the app. With DelegConfig and its
Test.aspx page, we can issue a GET request to a SharePoint API service
asking for the user name of the current user (via
https://server/path-to-web/_api/Web/CurrentUser). User information for
the user accessing DelegConfig accessing SharePoint should then be
visible in the HTML display.</p>

<h4>Conclusion</h4>

<p>With the shift to cloud and SharePoint
Online, <a href="https://en.wikipedia.org/wiki/OAuth">OAuth</a> and
Azure Active Directory dominate the authentication
landscape. On-premise, however, Kerberos is still very much
alive. While their authentication flows are similar, Kerberos can be
particular tricky to setup and troubleshoot.</p>

</div>

